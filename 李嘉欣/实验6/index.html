<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libra.js 数据可视化交互</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007acd;
        }
        
        h1 {
            color: #007acd;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        h2 {
            color: #333;
            margin: 30px 0 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        h3 {
            color: #555;
            margin: 20px 0 10px;
        }
        
        .visualization-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .viz-box {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .viz-box h3 {
            text-align: center;
            margin-top: 0;
        }
        
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .controls {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007acd;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        select, button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #007acd;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #005fa3;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9rem;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .brush-rect {
            fill: rgba(0, 122, 205, 0.2);
            stroke: #007acd;
            stroke-width: 1;
            stroke-dasharray: 5, 5;
        }
        
        .selected {
            fill: #ff6b6b !important;
            stroke: #ff3333 !important;
            stroke-width: 2 !important;
        }
        
        @media (max-width: 768px) {
            .visualization-container {
                flex-direction: column;
            }
            
            .viz-box {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Libra.js 数据可视化交互</h1>
            <p>基于Libra交互模型的数据可视化演示</p>
        </header>
        
        <div id="libraStatus" class="status warning">正在加载Libra.js模块...</div>
        
        <div class="viz-box">
            <h3>示例1: 悬停显示详细信息</h3>
            <div id="chart1" class="chart-container"></div>
            <p>将鼠标悬停在数据点上查看详细信息。</p>
            
            <div class="controls">
                <div class="control-group">
                    <label>数据点数量:</label>
                    <select id="dataCount1">
                        <option value="20">20个点</option>
                        <option value="50" selected>50个点</option>
                        <option value="100">100个点</option>
                    </select>
                    <button id="resetChart1">重置视图</button>
                </div>
            </div>
        </div>
        
        <div class="viz-box">
            <h3>示例2: 点击选择与高亮</h3>
            <div id="chart2" class="chart-container"></div>
            <p>支持三种选择模式：单选、多选和框选。</p>
            
            <div class="controls">
                <div class="control-group">
                    <label>选择模式:</label>
                    <select id="selectionMode">
                        <option value="single">单选</option>
                        <option value="multiple" selected>多选</option>
                        <option value="brush">框选</option>
                    </select>
                    <button id="clearSelection">清除选择</button>
                </div>
                <div class="control-group">
                    <label>已选择: <span id="selectedCount">0</span> 个点</label>
                </div>
            </div>
        </div>
        
        <div class="viz-box">
            <h3>示例3: 平移与缩放</h3>
            <div id="chart3" class="chart-container"></div>
            <p>使用鼠标滚轮进行缩放，拖拽进行平移。</p>
            
            <div class="controls">
                <div class="control-group">
                    <button id="zoomIn">放大</button>
                    <button id="zoomOut">缩小</button>
                    <button id="resetZoom">重置缩放</button>
                </div>
                <div class="control-group">
                    <label>当前缩放: <span id="zoomLevel">1.00</span>X</label>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 Libra.js 数据可视化交互示例</p>
        </footer>
    </div>

    <script type="module">
        let Libra;
        let hoverInstrument, clickInstrument, brushInstrument;
        let selectedPoints = new Set();
        let statusElement = document.getElementById('libraStatus');
        
        async function loadLibra() {
            try {
                const LibraModule = await import('./libra.js');
                
                console.log('Libra模块加载成功:', LibraModule);
                
                if (LibraModule.default) {
                    Libra = LibraModule.default;
                    console.log('使用默认导出:', Libra);
                } else {
                    Libra = LibraModule;
                    console.log('使用命名导出:', Libra);
                }
                
                console.log('Libra包含的属性:', Object.keys(Libra));
                
                if (Libra.Interactor) {
                    console.log('Interactor属性:', Object.keys(Libra.Interactor));
                }
                
                if (Libra && Libra.Instrument) {
                    statusElement.className = 'status success';
                    statusElement.textContent = 'Libra.js模块加载成功！';
                    console.log('Libra版本:', Libra.version || '未知版本');
                } else {
                    statusElement.className = 'status warning';
                    statusElement.textContent = 'Libra.js已加载但结构不符合预期，使用D3原生交互';
                }
            } catch (error) {
                statusElement.className = 'status error';
                statusElement.textContent = `Libra.js加载失败: ${error.message}`;
                console.error('Libra.js加载失败:', error);
                
                Libra = {};
            }
            
            initAllCharts();
        }
        
        function generateData(count, width, height) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push({
                    id: i,
                    x: Math.random() * (width - 40) + 20,
                    y: Math.random() * (height - 40) + 20,
                    value: Math.random() * 100,
                    category: Math.floor(Math.random() * 3)
                });
            }
            return data;
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedPoints.size;
        }
        
        function initChart1() {
            const container = document.getElementById('chart1');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select('#chart1').html('');
            
            const svg = d3.select('#chart1')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const dataCount = parseInt(document.getElementById('dataCount1').value);
            const data = generateData(dataCount, width, height);
            
            const circles = svg.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .attr('r', 5)
                .attr('fill', 'steelblue')
                .attr('stroke', 'white')
                .attr('stroke-width', 1);
            
            const tooltip = d3.select('body')
                .append('div')
                .style('position', 'absolute')
                .style('background', 'rgba(0, 0, 0, 0.8)')
                .style('color', 'white')
                .style('padding', '8px')
                .style('border-radius', '4px')
                .style('font-size', '12px')
                .style('pointer-events', 'none')
                .style('opacity', 0)
                .style('z-index', 1000);
            
            if (Libra && Libra.Instrument && Libra.Interactor && Libra.Interactor.Hover) {
                if (hoverInstrument) {
                    try {
                        hoverInstrument.destroy();
                    } catch (e) {
                        console.log('清理旧交互器失败:', e);
                    }
                }
                
                try {
                    hoverInstrument = Libra.Instrument({
                        interactor: Libra.Interactor.Hover({
                            onHover: (event, target) => {
                                const d = target.datum();
                                target.style('fill', '#ff6b6b');
                                target.attr('r', 7);
                                
                                tooltip
                                    .style('opacity', 1)
                                    .style('left', (event.pageX + 10) + 'px')
                                    .style('top', (event.pageY - 10) + 'px')
                                    .html(`值: ${d.value.toFixed(2)}<br>类别: ${d.category}<br>ID: ${d.id}`);
                            },
                            onLeave: (event, target) => {
                                target.style('fill', 'steelblue');
                                target.attr('r', 5);
                                tooltip.style('opacity', 0);
                            }
                        }),
                        layers: [circles]
                    });
                    console.log('Libra悬停交互器创建成功');
                } catch (error) {
                    console.error('Libra悬停交互器创建失败:', error);
                    setupD3Hover();
                }
            } else {
                setupD3Hover();
            }
            
            function setupD3Hover() {
                circles
                    .on('mouseover', function(event, d) {
                        d3.select(this)
                            .style('fill', '#ff6b6b')
                            .attr('r', 7);
                        
                        tooltip
                            .style('opacity', 1)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px')
                            .html(`值: ${d.value.toFixed(2)}<br>类别: ${d.category}<br>ID: ${d.id}`);
                    })
                    .on('mouseout', function() {
                        d3.select(this)
                            .style('fill', 'steelblue')
                            .attr('r', 5);
                        tooltip.style('opacity', 0);
                    });
            }
            
            document.getElementById('dataCount1').addEventListener('change', initChart1);
            document.getElementById('resetChart1').addEventListener('click', initChart1);
        }
        
        function initChart2() {
            const container = document.getElementById('chart2');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select('#chart2').html('');
            
            const svg = d3.select('#chart2')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const data = generateData(40, width, height);
            const colors = ['#007acd', '#4CAF50', '#FF9800'];
            
            const circles = svg.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', (d, i) => 20 + (i % 10) * ((width - 40) / 9))
                .attr('cy', (d, i) => 20 + Math.floor(i / 10) * ((height - 40) / 3))
                .attr('r', 6)
                .attr('fill', d => colors[d.category])
                .attr('stroke', 'white')
                .attr('stroke-width', 1)
                .attr('data-id', d => d.id)
                .classed('selected', false);
            
            selectedPoints.clear();
            updateSelectedCount();
            
            if (clickInstrument) {
                try {
                    clickInstrument.destroy();
                } catch (e) {
                    console.log('清理点击交互器失败:', e);
                }
            }
            
            if (brushInstrument) {
                try {
                    brushInstrument.destroy();
                } catch (e) {
                    console.log('清理刷选交互器失败:', e);
                }
            }
            
            const selectionMode = document.getElementById('selectionMode').value;
            
            function handleCircleClick(circle, mode) {
                const id = circle.attr('data-id');
                const isSelected = circle.classed('selected');
                
                if (mode === 'single') {
                    circles.classed('selected', false)
                        .attr('fill', d => colors[d.category])
                        .attr('r', 6)
                        .attr('stroke-width', 1);
                    
                    selectedPoints.clear();
                    
                    if (!isSelected) {
                        circle.classed('selected', true)
                            .attr('fill', '#ff6b6b')
                            .attr('r', 8)
                            .attr('stroke-width', 2);
                        selectedPoints.add(id);
                    }
                } else {
                    if (isSelected) {
                        circle.classed('selected', false)
                            .attr('fill', d => colors[d.category])
                            .attr('r', 6)
                            .attr('stroke-width', 1);
                        selectedPoints.delete(id);
                    } else {
                        circle.classed('selected', true)
                            .attr('fill', '#ff6b6b')
                            .attr('r', 8)
                            .attr('stroke-width', 2);
                        selectedPoints.add(id);
                    }
                }
                
                updateSelectedCount();
            }
            
            function handleBrushSelection(circles, brushExtent) {
                circles.classed('selected', false)
                    .attr('fill', d => colors[d.category])
                    .attr('r', 6)
                    .attr('stroke-width', 1);
                
                selectedPoints.clear();
                
                circles.each(function(d) {
                    const circle = d3.select(this);
                    const cx = parseFloat(circle.attr('cx'));
                    const cy = parseFloat(circle.attr('cy'));
                    
                    if (cx >= brushExtent.x && 
                        cx <= brushExtent.x + brushExtent.width &&
                        cy >= brushExtent.y && 
                        cy <= brushExtent.y + brushExtent.height) {
                        
                        circle.classed('selected', true)
                            .attr('fill', '#ff6b6b')
                            .attr('r', 8)
                            .attr('stroke-width', 2);
                        
                        selectedPoints.add(circle.attr('data-id'));
                    }
                });
                
                updateSelectedCount();
            }
            
            if (selectionMode === 'brush') {
                setupD3Brush();
            } else {
                setupD3Click();
            }

            function setupD3Click() {
                circles.on('click', function(event) {
                    const circle = d3.select(this);
                    handleCircleClick(circle, selectionMode);
                });
            }
            
            function setupD3Brush() {
                svg.selectAll('.brush').remove();
                
                const brush = d3.brush()
                    .extent([[0, 0], [width, height]])
                    .on('start brush end', function(event) {
                        if (event.type === 'end') {
                            if (!event.selection) return;
                            
                            const [[x0, y0], [x1, y1]] = event.selection;
                            const brushExtent = {
                                x: x0,
                                y: y0,
                                width: x1 - x0,
                                height: y1 - y0
                            };
                            
                            handleBrushSelection(circles, brushExtent);
                            
                            d3.select(this).call(brush.move, null);
                        }
                    });
                
                svg.append('g')
                    .attr('class', 'brush')
                    .call(brush);
            }
            
            document.getElementById('selectionMode').addEventListener('change', initChart2);
            document.getElementById('clearSelection').addEventListener('click', function() {
                circles.classed('selected', false)
                    .attr('fill', d => colors[d.category])
                    .attr('r', 6)
                    .attr('stroke-width', 1);
                
                selectedPoints.clear();
                updateSelectedCount();
            });
        }
        
        function initChart3() {
            const container = document.getElementById('chart3');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select('#chart3').html('');
            
            const svg = d3.select('#chart3')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const g = svg.append('g');
            
            const data = generateData(100, width, height);
            
            const circles = g.selectAll('circle')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .attr('r', 3)
                .attr('fill', d => d.category === 0 ? '#007acd' : 
                                    d.category === 1 ? '#4CAF50' : '#FF9800')
                .attr('stroke', 'white')
                .attr('stroke-width', 0.5);
            
            let transform = d3.zoomIdentity;
            let currentZoomLevel = 1.0;
            
            function updateZoomLevel() {
                document.getElementById('zoomLevel').textContent = currentZoomLevel.toFixed(2);
            }
            
            updateZoomLevel();
            
            const zoom = d3.zoom()
                .scaleExtent([0.5, 5])
                .on('zoom', (event) => {
                    transform = event.transform;
                    currentZoomLevel = transform.k;
                    g.attr('transform', transform);
                    updateZoomLevel();
                });
            
            svg.call(zoom);
            
            document.getElementById('zoomIn').addEventListener('click', function() {
                currentZoomLevel *= 1.2;
                transform = d3.zoomIdentity.scale(currentZoomLevel);
                g.attr('transform', transform);
                updateZoomLevel();
                svg.call(zoom.transform, transform);
            });
            
            document.getElementById('zoomOut').addEventListener('click', function() {
                currentZoomLevel *= 0.8;
                transform = d3.zoomIdentity.scale(currentZoomLevel);
                g.attr('transform', transform);
                updateZoomLevel();
                svg.call(zoom.transform, transform);
            });
            
            document.getElementById('resetZoom').addEventListener('click', function() {
                transform = d3.zoomIdentity;
                currentZoomLevel = 1.0;
                g.attr('transform', transform);
                updateZoomLevel();
                svg.call(zoom.transform, transform);
            });
        }
        
        function initAllCharts() {
            initChart1();
            initChart2();
            initChart3();
            
            window.addEventListener('resize', function() {
                initAllCharts();
            });
        }
        
        window.addEventListener('DOMContentLoaded', function() {
            loadLibra();
        });
    </script>
</body>
</html>