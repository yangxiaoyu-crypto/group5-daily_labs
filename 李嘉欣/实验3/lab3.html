<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>电子表格实践 I</title>
    <link rel="stylesheet" href="https://unpkg.com/x-data-spreadsheet@1.1.5/dist/xspreadsheet.css" />
    <script src="https://unpkg.com/x-data-spreadsheet@1.1.5/dist/xspreadsheet.js"></script>
    <script src="https://unpkg.com/x-data-spreadsheet@1.1.9/dist/locale/zh-cn.js"></script>
    <script src="https://d3js.org/d3.v6.js"></script>

    <style>
        body {
            display: flex;
            flex-direction: column;
            margin: 20px;
            font-family: "Microsoft YaHei";
        }

        .main {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
        }

        #xspreadsheet {
            width: 500px;
            height: 400px;
            border: 1px solid #ccc;
        }

        #my_dataviz {
            width: 700px;
            height: 400px;
            border: 1px solid #ccc;
            margin-left: 100px;
            margin-top: 80px;
            background-color: #fff;
            position: relative;
            z-index: 1;
        }

        .control {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="control">
        <input type="checkbox" id="showChart" />
        <label for="showChart">显示柱状图</label>
    </div>

    <div class="main">
        <div id="xspreadsheet"></div>
        <div id="my_dataviz"></div>
    </div>

    <script>
        x_spreadsheet.locale("zh-cn");
        const xs = x_spreadsheet("#xspreadsheet", {
            mode: 'edit',
            showToolbar: true,
            showGrid: true,
            row: { len: 10, height: 30 },
            col: { len: 5, width: 120 }
        });

        xs.cellText(0, 0, "年份")
            .cellText(0, 1, "产品A")
            .cellText(0, 2, "产品B")
            .cellText(1, 0, "2021")
            .cellText(1, 1, "50")
            .cellText(1, 2, "30")
            .cellText(2, 0, "2022")
            .cellText(2, 1, "70")
            .cellText(2, 2, "60")
            .cellText(3, 0, "2023")
            .cellText(3, 1, "90")
            .cellText(3, 2, "80")
            .reRender();

        function update() {
            const chartContainer = d3.select("#my_dataviz");
            chartContainer.selectAll("*").remove();

            if (!document.getElementById("showChart").checked) return;

            const data = [];
            const years = [];
            for (let i = 1; i <= 3; i++) {
                const yearCell = xs.cell(i, 0);
                const aCell = xs.cell(i, 1);
                const bCell = xs.cell(i, 2);
                if (!yearCell || !aCell || !bCell) continue;
                const year = yearCell.text || "";
                const valueA = parseInt(aCell.text) || 0;
                const valueB = parseInt(bCell.text) || 0;
                years.push(year);
                data.push({ year, A: valueA, B: valueB });
            }

            const svg = chartContainer.append("svg")
                .attr("width", 700)
                .attr("height", 400);

            const margin = { top: 40, right: 30, bottom: 40, left: 80 };
            const chartWidth = 500;
            const chartHeight = 300;
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            const bgLayer = g.append("g").attr("class", "background-layer");
            const axisLayer = g.append("g").attr("class", "axis-layer");
            const barLayer = g.append("g").attr("class", "bar-layer");
            const labelLayer = g.append("g").attr("class", "label-layer");

            bgLayer.append("rect")
                .attr("x", -60)
                .attr("y", -30)
                .attr("width", chartWidth + 120)
                .attr("height", chartHeight + 80)
                .attr("fill", "white")
                .attr("stroke", "#ddd");

            const x = d3.scaleBand()
                .domain(years)
                .range([0, chartWidth])
                .padding(0.2);
            const maxValue = d3.max(data, d => Math.max(d.A, d.B)) * 1.1;
            const y = d3.scaleLinear()
                .domain([0, maxValue])
                .range([chartHeight, 0]);
            axisLayer.append("g")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(d3.axisBottom(x));
            axisLayer.append("g").call(d3.axisLeft(y));

            barLayer.selectAll(".barA")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "barA")
                .attr("x", d => x(d.year))
                .attr("y", d => y(d.A))
                .attr("width", x.bandwidth() / 2 - 5)
                .attr("height", d => chartHeight - y(d.A))
                .attr("fill", "#3366cc");

            barLayer.selectAll(".barB")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "barB")
                .attr("x", d => x(d.year) + x.bandwidth() / 2 + 5)
                .attr("y", d => y(d.B))
                .attr("width", x.bandwidth() / 2 - 5)
                .attr("height", d => chartHeight - y(d.B))
                .attr("fill", "#dc3912");

            labelLayer.selectAll(".labelA")
                .data(data)
                .enter()
                .append("text")
                .attr("x", d => x(d.year) + 10)
                .attr("y", d => y(d.A) - 5)
                .attr("fill", "#333")
                .attr("font-size", "12px")
                .text(d => d.A);

            labelLayer.selectAll(".labelB")
                .data(data)
                .enter()
                .append("text")
                .attr("x", d => x(d.year) + x.bandwidth() / 2 + 15)
                .attr("y", d => y(d.B) - 5)
                .attr("fill", "#333")
                .attr("font-size", "12px")
                .text(d => d.B);
        }

        xs.on('cell-edited', update);
        document.getElementById("showChart").addEventListener("change", update);
    </script>
</body>

</html>